# Scripts: what they are, how they work, what language

## Languages used in scripts

- `build/recipes/*.sh` — **Bash** scripts (run by `just` and/or manually).
- `build/common/*.sh` — **Bash** shared libraries (sourced by many recipes).
- `build/common/build-icons-cache.py` — **Python 3** script.

## The shared “bootstrap” pattern

Most recipe scripts follow this pattern:

1. Define metadata:
   - `APP_NAME`, `APP_TITLE`, `RECIPE`
2. Set `COMMON_DIR` and source common code:
   - `source build/common/bootstrap.sh`
3. Run a `main "$@"` function.

`build/common/bootstrap.sh` loads:

- `build/common/functions.sh` — general helpers (`notify`, clipboard helpers, fuzzel helpers, metadata loader).
- `build/common/helpers.sh` — formatting helpers (colored output, headers), plus exported paths like `FLAKE_PATH`.

So when a recipe calls `notify` or `print_header`, it comes from these files.

## What the main recipes do

### Build / switch

- `build/recipes/rh-build.sh` (Bash)
  - wraps `sudo nixos-rebuild build|boot|dry-build|switch` for a given host.

- `build/recipes/rh-switch.sh` (Bash)
  - optional pre-flight: `nix flake check`.
  - runs `sudo nixos-rebuild switch --flake "${FLAKE_PATH}#${host}"`.
  - post-tasks (non-fast mode):
    - sources HM session vars (same logic as `rh-source-vars.sh`)
    - runs caches: `build/common/build-cache.sh -e`
    - builds icons cache: `python3 build/common/build-icons-cache.py`
    - reloads user services (`systemctl --user ...`, `makoctl reload`)

### Environment variables

- `build/recipes/rh-source-vars.sh` (Bash)
  - sources `/etc/profiles/per-user/$USER/etc/profile.d/hm-session-vars.sh` if it exists.
  - That file is generated by Home Manager and contains exported session variables.

### Caches

- `build/common/build-cache.sh` (Bash)
  - parses flags like `--apps`, `--wallpapers`, `--icons`, `--all`.
  - calls smaller scripts:
    - `build-cache-apps.sh`
    - `build-cache-launcher.sh`
    - `build-cache-wallpapers.sh`
  - can also update external tools’ caches (`bat`, `tldr`, `nix-index`).

- `build/common/build-icons-cache.py` (Python)
  - reads metadata from `~/.local/share/rhodium-utils/metadata.json`
  - reads unicode icon data from `~/.local/share/icons/icons.json`
  - writes cache files into `$XDG_CACHE_HOME/<app_name>/...`

### Health / housekeeping

- `build/recipes/rh-health.sh` (Bash)
  - checks git dirty/untracked state
  - prints disk usage
  - prints NixOS generations
  - checks a small list of user services

- `build/recipes/rh-gc.sh`, `rh-rollback.sh`, `rh-generation.sh`, etc.
  - wrappers around standard Nix/NixOS maintenance commands.

## How to run recipes directly

```zsh
./build/recipes/rh-health.sh
./build/recipes/rh-source-vars.sh
./build/recipes/rh-build.sh host_001 build
```

Most people use `just`, which simply calls these scripts.
